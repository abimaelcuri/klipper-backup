[gcode_macro tool_state]
variable_active_tool: 0
gcode:
    ; Macro apenas para armazenar o estado atual do extrusor

[gcode_macro FILAMENT_UNLOAD]
description: "Descarrega filamento da extrusora atual"
gcode:
    G91
    G1 E-20 F1200
    G1 E-50 F2200
    G90

[gcode_macro FILAMENT_LOAD]
description: "Carrega filamento na extrusora atual"
gcode:
    G91
    G1 E50 F2200
    G1 E20 F1200
    G90

[gcode_macro SETT0]
gcode:
    M118 Trocando para extrusor 0
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder
    
    SET_GCODE_VARIABLE MACRO=tool_state VARIABLE=active_tool VALUE=0
    SAVE_VARIABLE VARIABLE=active_tool VALUE=0

[gcode_macro SETT1]
gcode: 
    M118 Trocando para extrusor 1
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    
    SET_GCODE_VARIABLE MACRO=tool_state VARIABLE=active_tool VALUE=1
    SAVE_VARIABLE VARIABLE=active_tool VALUE=1
    
[gcode_macro STARTUP_TOOL_RESTORE]
description: "Restaura o extrusor ativo após inicialização"
gcode:
    {% if printer.save_variables is defined and printer.save_variables.variables.active_tool is defined %}
        {% set saved_tool = printer.save_variables.variables.active_tool %}
        SET_GCODE_VARIABLE MACRO=tool_state VARIABLE=active_tool VALUE={saved_tool}
        
        {% if saved_tool == 0 %}
            SETT0
        {% elif saved_tool == 1 %}
            SETT1
        {% else %}
            M118 Valor de extrusor inválido: {saved_tool}
        {% endif %}
    {% else %}
        SETT0
    {% endif %}

[gcode_macro T0]
gcode:
    TX EXTRUDER=0 PURGE=30
    
[gcode_macro T1]
gcode:
    TX EXTRUDER=1 PURGE=30

[gcode_macro TX]
gcode:
    {% set extruder = params.EXTRUDER | default(0) | int %}
    {% if printer["gcode_macro tool_state"].active_tool == extruder %}
        M118 Já estamos no T{extruder}, ignorando.
    {% else %}
        {% set x_start = printer.toolhead.position.x %}

        # Go to material wipe position
        G91
        G1 Z3 F1200
        G90
        G1 X248 F6000
        
        # Retract filament from TX
        M118 Retraindo filamento T{extruder}
        FILAMENT_UNLOAD

        # Set extruder 
        {% if extruder == 0 %}
            SETT0
        {% else %}
            SETT1
        {% endif %}
        
        # Extract filament from TX
        M118 Extrudindo filamento T{extruder}
        FILAMENT_LOAD

        # Purge material according to OrcaSlicer Material params
        {% set purge_total = params.PURGE | default(40) | float %}
        PURGE TOTAL={purge_total}

        # Clean nozzle
        WIPE TOTAL=3

        # Go back to initial X
        G1 X{x_start} F6000

        # Go back to initial Z
        G91
        G1 Z-3 F1200
        G90
        
        G92 E0
    {% endif %}

[gcode_macro WIPE]
gcode:
    {% set wipe_count = params.TOTAL | default(3) | int %}
    {% for wipe in range(wipe_count) %}
      G1 X235 F1000
      G1 X248 F600
    {% endfor %}
    
[gcode_macro PURGE]
gcode:
    {% set purge_total = params.TOTAL | default(40) | float %}
    {% set velocidade_padrao = 400 %}
    {% set velocidade_final = 200 %}
    {% set purgado = 0 %}
    {% set continuar_purga = True %}
    {% set max_iteracoes = 10 %} ; Segurança contra loops infinitos

    M118 Realizando purga de {purge_total:.2f}mm...
    G91
    {% for i in range(max_iteracoes) %}
        {% if continuar_purga %}
            {% set restante = purge_total - purgado %}
            {% set extrudar = [50, restante] | min %}
            {% set velocidade = velocidade_padrao %}
            {% if restante <= 50 %}
                {% set velocidade = velocidade_final %}
            {% endif %}
            G1 E{extrudar} F{velocidade}
            {% set purgado = purgado + extrudar %}
            M118 Purgado {purgado:.2f}mm de {purge_total:.2f}mm na velocidade {velocidade|float:.0f}
            {% if purgado >= purge_total %}
                {% set continuar_purga = False %}
            {% endif %}
        {% endif %}
    {% endfor %}
    G1 E-3 F1200
    G90

# [gcode_macro purge]
# gcode:
#   G1 E5 F2700  # Purgar 5mm de filamento
#   G1 E75 F300  # Purgar 75mm de filamento
#   M106 S150
#   G4 P2000
#   G4 P3000
#   M107
#   G1 X228 F13000  # 1er limpieza
#   G1 X248 F3000  # 2da limpieza
#   G1 X228 F13000  # 3er limpieza
#   G1 X248 F3000  # 4ta limpieza
#   G1 X228 F13000  # 5ta limpieza
#   G1 X248 F3000  # 1er limpieza (parece haver uma repetição aqui, talvez seja intencional)
#   G1 X228 F13000  # 2da limpieza (idem)
#   G1 X248 F13000  # 3er limpieza (idem)
#   G1 X228 F3000  # 4ta limpieza (idem)
#   G1 X245 F13000  # 5ta limpieza (idem)
#   G92 E0
#   G1 E-0.8 F2700